<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç”µè§†é€‰è´­ 1.0</title>
  <style>
    :root{--bg:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--border:rgba(148,163,184,.18);--accent:#60a5fa;--accent2:#34d399;--shadow:0 12px 30px rgba(0,0,0,.35);--radius:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.25), transparent 60%),
                 radial-gradient(1000px 500px at 90% 10%, rgba(52,211,153,.18), transparent 55%), var(--bg);
      color:var(--text);}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px;}
    .header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:14px;}
    .title{font-size:28px;font-weight:800;letter-spacing:.5px;margin:0;}
    .subtitle{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.4;}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(15,23,42,.6);color:var(--muted);font-size:12px;white-space:nowrap;}

    .layout{height:calc(100vh - 120px);min-height:520px;background:rgba(15,23,42,.65);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;backdrop-filter:blur(8px);}
    .messages{flex:1;padding:18px 18px 8px 18px;overflow:auto;}
    .msg{display:flex;margin:10px 0;gap:10px;align-items:flex-start;}
    .avatar{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(96,165,250,.18);border:1px solid var(--border);color:var(--accent);font-weight:700;flex:0 0 auto;}
    .bubble{max-width:820px;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(17,28,51,.72);line-height:1.55;white-space:pre-wrap;word-break:break-word;}
    .me .avatar{background:rgba(52,211,153,.16);color:var(--accent2);}
    .me .bubble{background:rgba(16,185,129,.10);border-color:rgba(52,211,153,.25);}

    .meta{color:var(--muted);font-size:12px;padding:0 18px 10px 18px;border-top:1px solid rgba(148,163,184,.10);background:rgba(15,23,42,.45);}
    .composer{padding:12px 12px 14px 12px;border-top:1px solid rgba(148,163,184,.16);background:rgba(15,23,42,.72);display:flex;gap:10px;align-items:flex-end;}
    textarea{flex:1;resize:none;min-height:44px;max-height:160px;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(2,6,23,.35);color:var(--text);outline:none;line-height:1.4;}
    textarea:focus{border-color:rgba(96,165,250,.55);box-shadow:0 0 0 4px rgba(96,165,250,.12);}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(96,165,250,.45);background:rgba(96,165,250,.18);color:var(--text);cursor:pointer;font-weight:700;height:44px;display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .btn:hover{filter:brightness(1.12);}
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:none;}

    /* Upload panel */
    .panel{
      background:rgba(15,23,42,.65);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:14px;
      backdrop-filter:blur(8px);
    }
    .panel-title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .panel-title h2{font-size:15px;margin:0;font-weight:800;letter-spacing:.2px;}
    .panel-title .hint{color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .label{color:var(--muted);font-size:12px;}
    input[type="file"], input[type="text"]{
      border-radius:12px;border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.35);color:var(--text);
      padding:10px 12px;outline:none;
    }
    input[type="text"]:focus{
      border-color:rgba(96,165,250,.55);box-shadow:0 0 0 4px rgba(96,165,250,.12);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .status{color:var(--muted);font-size:12px;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(15,23,42,.6);color:var(--muted);font-size:12px;
    }
    details{margin-top:12px;border:1px solid rgba(148,163,184,.14);border-radius:12px;overflow:hidden;background:rgba(17,28,51,.45);}
    summary{cursor:pointer;padding:10px 12px;user-select:none;color:var(--text);font-weight:800;}
    .prewrap{padding:12px 12px 14px 12px;margin:0;white-space:pre-wrap;word-break:break-word;color:var(--text);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;line-height:1.55;}
    .divider{height:1px;background:rgba(148,163,184,.10);}

    @media (max-width:700px){
      .layout{height:calc(100vh - 110px);}
      .bubble{max-width:100%;}
      .header{flex-direction:column;align-items:flex-start;}
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">ç”µè§†é€‰è´­ 1.0 <span style="font-size:16px;font-weight:700;color:var(--muted)">ï¼ˆèŠå¤©å…¥å£ï¼‰</span></h1>
        <p class="subtitle">ä¾‹ï¼š75å¯¸ ps5 é¢„ç®—8000 ç™½å¤©å®¢å…å¾ˆäº® / æˆ‘åªçœ‹TCL / 10000ä»¥å†… / 1.3ä¸‡ä»¥å†… / 10kä»¥å†… / é‡ç½®</p>
      </div>
      <div class="badge" id="stateBadge">å·²æ”¶é›†ï¼šæš‚æ— </div>
    </div>

    <!-- Upload + Contrast -->
    <div class="panel">
      <div class="panel-title">
        <h2>ğŸ“· å¯¹æ¯”åº¦æˆªå›¾åˆ†æï¼ˆä¸¤å¼ å›¾ â†’ YAML + è¯„æµ‹ç»“è®ºï¼‰</h2>
        <div class="hint">ä¸Šä¼ ä¸¤å¼ æˆªå›¾ï¼šåŸç”Ÿ(Local Dimming OFF) + æœ‰æ•ˆ(Local Dimming ON)</div>
      </div>

      <div class="grid">
        <div class="field">
          <div class="label">åŸç”Ÿå¯¹æ¯”åº¦å›¾ï¼ˆLocal Dimming OFFï¼‰</div>
          <input id="nativeFile" type="file" accept=".png,.jpg,.jpeg,.webp" />
        </div>
        <div class="field">
          <div class="label">æœ‰æ•ˆå¯¹æ¯”åº¦å›¾ï¼ˆLocal Dimming ON / High / Autoï¼‰</div>
          <input id="effectiveFile" type="file" accept=".png,.jpg,.jpeg,.webp" />
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex:1;min-width:240px;">
          <div class="label">è®¾å¤‡IDï¼ˆå¯é€‰ï¼Œç”¨äºæ–‡ä»¶å‘½åï¼‰</div>
          <input id="deviceId" type="text" placeholder="ä¾‹å¦‚ hisense_85e8sï¼ˆä¸å¡«ä¹Ÿå¯ä»¥ï¼‰" />
        </div>

        <button class="btn" id="btnAnalyze">ä¸€é”®ç”Ÿæˆç»“è®º</button>
        <span class="pill" id="uploadPill">çŠ¶æ€ï¼šå¾…ä¸Šä¼ </span>
      </div>

      <div class="status" id="uploadStatus" style="margin-top:10px;"></div>

      <details id="yamlDetails">
        <summary>æŸ¥çœ‹ç”Ÿæˆçš„ YAMLï¼ˆæ¥è‡ª /api/g2/contrast_ocrï¼‰</summary>
        <div class="divider"></div>
        <pre class="prewrap" id="yamlOut"></pre>
      </details>

      <details id="analysisDetails" open>
        <summary>æŸ¥çœ‹ç”Ÿæˆçš„è¯„æµ‹ç»“è®ºï¼ˆæ¥è‡ª /api/report/contrastï¼‰</summary>
        <div class="divider"></div>
        <pre class="prewrap" id="analysisOut"></pre>
      </details>
    </div>

    <!-- Chat -->
    <div class="layout">
      <div class="messages" id="messages"></div>
      <div class="meta">Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ</div>

      <div class="composer">
        <textarea id="input" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚â€¦" rows="1"></textarea>
        <button class="btn" id="sendBtn">å‘é€</button>
      </div>
    </div>
  </div>

<script>
  // ===== Chat =====
  let state = null;
  const $messages = document.getElementById('messages');
  const $input = document.getElementById('input');
  const $sendBtn = document.getElementById('sendBtn');
  const $stateBadge = document.getElementById('stateBadge');

  function updateBadge(s){
    if(!s){ $stateBadge.textContent = 'å·²æ”¶é›†ï¼šæš‚æ— '; return; }
    const parts = [];
    if(s.brand) parts.push(`å“ç‰Œ=${s.brand}`);
    if(s.budget !== null && s.budget !== undefined) parts.push(`é¢„ç®—â‰¤${s.budget}`);
    if(s.size !== null && s.size !== undefined) parts.push(`å°ºå¯¸â‰ˆ${s.size}`);
    if(s.scene) parts.push(`åœºæ™¯=${s.scene}`);
    $stateBadge.textContent = 'å·²æ”¶é›†ï¼š' + (parts.length ? parts.join('ï¼Œ') : 'æš‚æ— ');
  }

  function addMsg(role, text){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'me' ? 'me' : 'bot');
    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = role === 'me' ? 'æˆ‘' : 'AI';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    wrap.appendChild(av); wrap.appendChild(bubble);
    $messages.appendChild(wrap);
    $messages.scrollTop = $messages.scrollHeight;
  }

  function autosize(){
    $input.style.height = 'auto';
    $input.style.height = Math.min($input.scrollHeight, 160) + 'px';
  }

  async function send(){
    const text = ($input.value || '').trim();
    if(!text) return;

    addMsg('me', text);
    $input.value = '';
    autosize();
    $sendBtn.disabled = true;

    try{
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text, state})
      });
      const data = await resp.json();
      state = data.state;
      updateBadge(state);
      addMsg('bot', data.reply);
    }catch(e){
      addMsg('bot', 'âš ï¸ è¯·æ±‚å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
    }finally{
      $sendBtn.disabled = false;
      $input.focus();
    }
  }

  $input.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  $input.addEventListener('input', autosize);
  $sendBtn.addEventListener('click', send);
  updateBadge(state); autosize(); $input.focus();

  // ===== Upload & Contrast Report =====
  const $nativeFile = document.getElementById("nativeFile");
  const $effectiveFile = document.getElementById("effectiveFile");
  const $deviceId = document.getElementById("deviceId");
  const $btnAnalyze = document.getElementById("btnAnalyze");
  const $uploadStatus = document.getElementById("uploadStatus");
  const $uploadPill = document.getElementById("uploadPill");
  const $yamlOut = document.getElementById("yamlOut");
  const $analysisOut = document.getElementById("analysisOut");
  const $yamlDetails = document.getElementById("yamlDetails");
  const $analysisDetails = document.getElementById("analysisDetails");

  function setPill(text){ $uploadPill.textContent = "çŠ¶æ€ï¼š" + text; }
  function setStatus(text){ $uploadStatus.textContent = text || ""; }

  async function uploadOne(file){
    const fd = new FormData();
    fd.append("file", file);
    const resp = await fetch("/api/upload", { method: "POST", body: fd });
    if(!resp.ok){
      const t = await resp.text();
      throw new Error("ä¸Šä¼ å¤±è´¥: " + t);
    }
    return await resp.json(); // { image_id, path }
  }

  $btnAnalyze.addEventListener("click", async () => {
    const nativeFile = $nativeFile.files[0];
    const effectiveFile = $effectiveFile.files[0];

    $yamlOut.textContent = "";
    $analysisOut.textContent = "";
    setStatus("");
    setPill("å¾…ä¸Šä¼ ");

    if(!nativeFile || !effectiveFile){
      setStatus("è¯·å…ˆé€‰æ‹©ä¸¤å¼ å›¾ç‰‡ï¼ˆåŸç”Ÿå›¾ + æœ‰æ•ˆå›¾ï¼‰ã€‚");
      return;
    }

    $btnAnalyze.disabled = true;
    try{
      setPill("ä¸Šä¼ ä¸­");
      setStatus("æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...");

      const up1 = await uploadOne(nativeFile);
      const up2 = await uploadOne(effectiveFile);

      // STEP 1: OCR -> YAML
      setPill("ç”ŸæˆYAML");
      setStatus("ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆ YAMLï¼ˆ/api/g2/contrast_ocrï¼‰...");

      const payload1 = {
        native_image_id: up1.image_id,
        effective_image_id: up2.image_id,
        device_id: ($deviceId.value || "").trim() || null
      };

      const resp1 = await fetch("/api/g2/contrast_ocr", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload1)
      });

      if(!resp1.ok){
        const t = await resp1.text();
        throw new Error("ç”Ÿæˆ YAML å¤±è´¥: " + t);
      }

      const data1 = await resp1.json(); // { yaml, saved_to }
      const yamlText = data1.yaml || "";
      $yamlOut.textContent = yamlText;
      $yamlDetails.open = true;

      // STEP 2: YAML -> Report
      setPill("ç”Ÿæˆç»“è®º");
      setStatus("YAML å·²ç”Ÿæˆï¼Œæ­£åœ¨ç”Ÿæˆè¯„æµ‹ç»“è®ºï¼ˆ/api/report/contrastï¼‰...");

      const payload2 = { yaml_text: yamlText };

      const resp2 = await fetch("/api/report/contrast", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload2)
      });

      if(!resp2.ok){
        const t = await resp2.text();
        throw new Error("ç”Ÿæˆç»“è®ºå¤±è´¥: " + t);
      }

      const data2 = await resp2.json();
      // data2.analysis_text + data2.editorial_verdict_yaml
      const analysisText = (data2.analysis_text || "").trim();
      const editorialYaml = (data2.editorial_verdict_yaml || "").trim();

      $analysisOut.textContent =
        analysisText + (editorialYaml ? ("\n\n" + editorialYaml) : "");

      $analysisDetails.open = true;

      setPill("å®Œæˆ");
      const savedYaml = data1.saved_to ? ("YAMLå·²ä¿å­˜: " + data1.saved_to) : "";
      setStatus("âœ… å·²ç”Ÿæˆã€‚" + (savedYaml ? (" " + savedYaml) : ""));
    }catch(e){
      setPill("å¤±è´¥");
      setStatus("âŒ " + (e && e.message ? e.message : String(e)));
    }finally{
      $btnAnalyze.disabled = false;
    }
  });
</script>
</body>
</html>
